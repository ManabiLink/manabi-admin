<!-- しょうにん判断画面 -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>専門家用 投稿審査パネル</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-t-4 border-indigo-500">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-600 mb-2">専門家用 投稿審査パネル</h1>
                    <p class="text-gray-600">保護者からの投稿を確認し、公開可否を判断してください</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">審査待ち</div>
                    <div class="text-3xl font-bold text-indigo-600" id="pendingCount">0</div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-400">
                <div class="text-sm text-gray-500">承認済み</div>
                <div class="text-2xl font-bold text-green-600" id="approvedCount">0</div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-red-400">
                <div class="text-sm text-gray-500">却下</div>
                <div class="text-2xl font-bold text-red-600" id="rejectedCount">0</div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-yellow-400">
                <div class="text-sm text-gray-500">本日の審査数</div>
                <div class="text-2xl font-bold text-yellow-600" id="todayCount">0</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex gap-2 flex-wrap">
                <button onclick="filterPosts('pending')" id="tab-pending" class="px-4 py-2 rounded-lg font-medium transition-all bg-indigo-500 text-white">
                    審査待ち
                </button>
                <button onclick="filterPosts('approved')" id="tab-approved" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                    承認済み
                </button>
                <button onclick="filterPosts('rejected')" id="tab-rejected" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                    却下済み
                </button>
            </div>
        </div>

        <!-- Posts List -->
        <div id="postsList" class="space-y-4">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
                読み込み中...
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">却下理由を選択してください</h2>
            <div class="space-y-2 mb-4">
                <label class="flex items-center gap-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="reason" value="inappropriate" class="text-indigo-600">
                    <span>不適切な内容が含まれる</span>
                </label>
                <label class="flex items-center gap-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="reason" value="personal" class="text-indigo-600">
                    <span>個人情報が含まれる</span>
                </label>
                <label class="flex items-center gap-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="reason" value="spam" class="text-indigo-600">
                    <span>スパムまたは広告</span>
                </label>
                <label class="flex items-center gap-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="reason" value="violence" class="text-indigo-600">
                    <span>暴力的な表現を含む</span>
                </label>
                <label class="flex items-center gap-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="reason" value="other" class="text-indigo-600">
                    <span>その他</span>
                </label>
            </div>
            <textarea 
                id="rejectionNote" 
                placeholder="詳細な理由（任意）"
                rows="3"
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-400 focus:border-transparent resize-none"
            ></textarea>
            <div class="flex gap-2">
                <button onclick="confirmRejection()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    却下する
                </button>
                <button onclick="closeRejectionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                    キャンセル
                </button>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            general: { label: '日々の悩み', color: 'bg-pink-100 text-pink-800' },
            health: { label: '健康・発達', color: 'bg-rose-100 text-rose-800' },
            education: { label: '学習・進路', color: 'bg-purple-100 text-purple-800' },
            relationship: { label: '親子関係', color: 'bg-fuchsia-100 text-fuchsia-800' },
            lifestyle: { label: '生活・習慣', color: 'bg-pink-100 text-pink-800' }
        };

        let currentFilter = 'pending';
        let currentRejectionPostId = null;

        window.addEventListener('load', loadPosts);

        async function loadPosts() {
            try {
                const keys = await window.storage.list('post:', true);
                const moderationKeys = await window.storage.list('moderation:', true);
                
                if (!keys || !keys.keys || keys.keys.length === 0) {
                    document.getElementById('postsList').innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">投稿がありません</div>';
                    updateStats([]);
                    return;
                }

                const posts = await Promise.all(
                    keys.keys.map(async (key) => {
                        try {
                            const result = await window.storage.get(key, true);
                            const post = result ? JSON.parse(result.value) : null;
                            if (!post) return null;

                            // Check moderation status
                            try {
                                const modResult = await window.storage.get(`moderation:${post.id}`, true);
                                post.moderationStatus = modResult ? JSON.parse(modResult.value) : { status: 'pending' };
                            } catch {
                                post.moderationStatus = { status: 'pending' };
                            }

                            return post;
                        } catch {
                            return null;
                        }
                    })
                );

                const validPosts = posts.filter(p => p).sort((a, b) => b.timestamp - a.timestamp);
                displayPosts(validPosts);
                updateStats(validPosts);
            } catch (error) {
                console.log('読み込みエラー', error);
                document.getElementById('postsList').innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">投稿がありません</div>';
            }
        }

        function updateStats(posts) {
            const pending = posts.filter(p => p.moderationStatus.status === 'pending').length;
            const approved = posts.filter(p => p.moderationStatus.status === 'approved').length;
            const rejected = posts.filter(p => p.moderationStatus.status === 'rejected').length;
            
            const today = new Date().toDateString();
            const todayReviewed = posts.filter(p => {
                if (!p.moderationStatus.reviewedAt) return false;
                return new Date(p.moderationStatus.reviewedAt).toDateString() === today;
            }).length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('todayCount').textContent = todayReviewed;
        }

        function displayPosts(posts) {
            const filteredPosts = posts.filter(p => p.moderationStatus.status === currentFilter);
            const postsList = document.getElementById('postsList');
            
            if (filteredPosts.length === 0) {
                postsList.innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
                    ${currentFilter === 'pending' ? '審査待ちの投稿はありません' : 
                      currentFilter === 'approved' ? '承認済みの投稿はありません' : 
                      '却下済みの投稿はありません'}
                </div>`;
                return;
            }

            postsList.innerHTML = filteredPosts.map(post => createPostHTML(post)).join('');
        }

        function createPostHTML(post) {
            const category = categories[post.category];
            const status = post.moderationStatus.status;
            const isPending = status === 'pending';
            
            let statusBadge = '';
            if (status === 'approved') {
                statusBadge = '<span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">✓ 承認済み</span>';
            } else if (status === 'rejected') {
                statusBadge = '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">✗ 却下済み</span>';
            } else {
                statusBadge = '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">⏱ 審査待ち</span>';
            }

            let moderationInfo = '';
            if (post.moderationStatus.reviewedAt) {
                const date = new Date(post.moderationStatus.reviewedAt);
                moderationInfo = `
                    <div class="mt-3 pt-3 border-t border-gray-200 text-sm text-gray-600">
                        <div><strong>審査日時:</strong> ${date.toLocaleString('ja-JP')}</div>
                        ${post.moderationStatus.reason ? `<div><strong>理由:</strong> ${getRejectionReasonLabel(post.moderationStatus.reason)}</div>` : ''}
                        ${post.moderationStatus.note ? `<div><strong>メモ:</strong> ${escapeHtml(post.moderationStatus.note)}</div>` : ''}
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow ${isPending ? 'border-l-4 border-yellow-400' : status === 'approved' ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400'}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex gap-2">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${category.color}">
                                ${category.label}
                            </span>
                            ${statusBadge}
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ${formatTime(post.timestamp)}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="text-sm text-gray-600 mb-2"><strong>投稿者:</strong> ${escapeHtml(post.nickname)}</div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                        </div>
                    </div>

                    ${moderationInfo}

                    ${isPending ? `
                        <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                            <button onclick="approvePost('${post.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                承認する
                            </button>
                            <button onclick="openRejectionModal('${post.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                却下する
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function approvePost(postId) {
            if (!confirm('この投稿を承認しますか？承認すると掲示板に公開されます。')) return;

            try {
                const moderation = {
                    status: 'approved',
                    reviewedAt: Date.now(),
                    reviewer: 'expert'
                };
                await window.storage.set(`moderation:${postId}`, JSON.stringify(moderation), true);
                await loadPosts();
                alert('投稿を承認しました');
            } catch (error) {
                alert('承認に失敗しました');
            }
        }

        function openRejectionModal(postId) {
            currentRejectionPostId = postId;
            document.getElementById('rejectionModal').classList.remove('hidden');
            document.querySelectorAll('input[name="reason"]').forEach(input => input.checked = false);
            document.getElementById('rejectionNote').value = '';
        }

        function closeRejectionModal() {
            document.getElementById('rejectionModal').classList.add('hidden');
            currentRejectionPostId = null;
        }

        async function confirmRejection() {
            const selectedReason = document.querySelector('input[name="reason"]:checked');
            if (!selectedReason) {
                alert('却下理由を選択してください');
                return;
            }

            const note = document.getElementById('rejectionNote').value.trim();

            try {
                const moderation = {
                    status: 'rejected',
                    reviewedAt: Date.now(),
                    reviewer: 'expert',
                    reason: selectedReason.value,
                    note: note
                };
                await window.storage.set(`moderation:${currentRejectionPostId}`, JSON.stringify(moderation), true);
                closeRejectionModal();
                await loadPosts();
                alert('投稿を却下しました');
            } catch (error) {
                alert('却下に失敗しました');
            }
        }

        function filterPosts(filter) {
            currentFilter = filter;
            
            // Update tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('bg-indigo-500', 'text-white');
                tab.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`tab-${filter}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`tab-${filter}`).classList.add('bg-indigo-500', 'text-white');
            
            loadPosts();
        }

        function getRejectionReasonLabel(reason) {
            const labels = {
                inappropriate: '不適切な内容が含まれる',
                personal: '個人情報が含まれる',
                spam: 'スパムまたは広告',
                violence: '暴力的な表現を含む',
                other: 'その他'
            };
            return labels[reason] || reason;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>